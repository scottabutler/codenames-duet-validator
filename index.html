<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Display Webcam Stream</title>
    
    <style>
      #container {
        //margin: 0px auto;
        width: 500px;
        height: 375px;
        border: 10px #333 solid;
      }
      #videoElement {
        width: 500px;
        height: 375px;
        background-color: #666;
      }
      .output {
        display:inline-block;
        width: 330px;
        height: 250px;
      }
      input[type=button] {
        height: 50px;
        width: 80px;
      }
    </style>
  </head>
 
  <body onload="main()">
  <div id="container">
    <video autoplay="true" id="videoElement">
    
    </video>
  </div>
  <input type="button" onclick="stop()" value="Stop" />
  <input type="button" onclick="captureImage(1)" value="Capture 1" />
  <input type="button" onclick="captureImage(2)" value="Capture 2" /><br />
  <div class="output" id="output_1"></div>
  <div class="output" id="squares_1"></div><br />
  <div class="output" id="output_2"></div>
  <div class="output" id="squares_2"></div>
  <script>
    var video = document.getElementById("videoElement");

    if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          video.srcObject = stream;
        })
        .catch(function (err0r) {
          console.log("Something went wrong!", err0r);
        });
    }

    var squares = [
      ["", "", "", "", ""],
      ["", "", "", "", ""],
      ["", "", "", "", ""],
      ["", "", "", "", ""],
      ["", "", "", "", ""]
    ];

    function main() {
      //Reset
      reset(1);
      reset(2);
      console.log("ready");
    }

    function reset(counter) {
      document.getElementById("squares_" + counter).innerHTML = "";
      document.getElementById("output_" + counter).innerHTML = "";
    }

    function getCanvasContext(canvas) {
      
      var ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      return ctx;
    }

    function getCanvas() {
      var scale = 0.5;

      //Set up the canvas to capture the image
      var canvas = document.createElement("canvas");
      canvas.setAttribute("id", "canvas");

      //Scale the canvas
      canvas.width = video.videoWidth * scale;
      canvas.height = video.videoHeight * scale;

      return canvas;
    }

    function renderImage(counter, imgData, context, canvas) {
      //Render the image onto the screen
      context.putImageData(imgData, 0, 0);

      var img = document.createElement("img");
      img.src = canvas.toDataURL();
      img.setAttribute("id", "rendered_" + counter);

      document.getElementById("output_" + counter).appendChild(img);
    }

    function captureImage(counter) {     
      reset(counter);
      var canvas = getCanvas();
      var context = getCanvasContext(canvas);

      //Capture the image
      var imgData = context.getImageData(0, 0, canvas.width, canvas.height);

      //Initial coordinates for processing
      var x = 25;
      var y = 25;

      //Loop across 5 columns for 5 rows
      for (var yCount = 0; yCount < 5; yCount++){

        for (var xCount = 0; xCount < 5; xCount++){
          var rgb = getAverageRgb(context, x, y);
          x+=22;
          var parsedColour = parseColour(rgb);

          //Append the first letter of the parsed colour onto anything already in the array
          //Do an alpha sort to make comparison easier later
          var existing = squares[yCount][xCount];
          var sorted = (existing += parsedColour[0]).split('').sort().join('');
          squares[yCount][xCount] = sorted;

          printColour(rgb, parsedColour, counter);              
        }

        //Reset the X coord to the starting position and increment Y to the next row
        x = 25;
        y += 16;

        newLine(counter);
      }

      renderImage(counter, imgData, context, canvas);

      console.log(squares);

      if (counter == 2) {
        calculate(squares);
      }
    };

    function calculate(sq) {
      var greens = 0;
      var blacks = 0;
      var overlappingGreens = 0;
      var greenBlacks = 0;
      var tanBlacks = 0;
      var overlappingBlacks = 0;
      
      //Loop across 5 columns for 5 rows
      for (var yCount = 0; yCount < 5; yCount++) {
        for (var xCount = 0; xCount < 5; xCount++) {
          var val = sq[yCount][xCount];
          
          greens += val.split('g').length - 1;
          blacks += val.split('b').length - 1;

          /*if (val.indexOf("g") > -1)
            greens++;

          if (val.indexOf("b") > -1)
            blacks++;*/

          if (val == "gg")
            overlappingGreens++;

          if (val == "bb")
            overlappingBlacks++;

          if (val == "bg")
            greenBlacks++;
          
          if (val == "bt")
            tanBlacks++;
          
        }
      }

      console.log("RESULTS:");
      console.log("greens", greens);
      console.log("blacks", blacks);
      console.log("overlapping greens", overlappingGreens);
      console.log("overlapping blacks", overlappingBlacks);
      console.log("green blacks", greenBlacks);
      console.log("tan blacks", tanBlacks);
    }

    function printColour(rgb, parsedColour, counter) {
      var col = rgb; //parsedColour[0] == "u" ? "255,0,0" : rgb;
      var s = document.createElement("span");
        s.setAttribute("style", "display: inline-block; background-color: rgb(" + col + "); width: 40px; height: 40px;");
        s.innerText = parsedColour[0];
        document.getElementById("squares_" + counter).appendChild(s);    
    }

    function parseColour(rgb) {
      var c = rgb.split(',');
      var result = "unknown";
      
      var r = c[0]*1;
      var g = c[1]*1;
      var b = c[2]*1;

      if (g > r+30 && g > b+30 && r < 100 && b < 100) {
        result = "green";
      }
      else if (r < 65 && g < 65 && b < 65) {
        result = "black";
      }
      else if (Math.floor((r + g + b)/3) > 90) { //(r > 120 && g > 120 && b > 120) {
        result = "tan";
      }
      return result;
    }

    function newLine(counter) {
      document.getElementById("squares_" + counter).appendChild(document.createElement("br"));
    }

    function getRgb(ctx, x, y) {
      var imgData = ctx.getImageData(x, y, 1, 1);
      var r = imgData.data[0];
      var g = imgData.data[1];
      var b = imgData.data[2];
      var result = r + ',' + g + ',' + b;
      return result;
    }    

    function getAverageRgb(ctx, x, y) {
      var captureWidth = 15;
      var captureHeight = 8;
      var totalDataPoints = captureWidth * captureHeight * 4; //Data will be one array of rgba values, 4 entries per pixel
      var totalPixels = totalDataPoints / 4;

      var imgData = ctx.getImageData(x, y, captureWidth, captureHeight);

      var r = 0; var g = 0; var b = 0;

      for (var i = 0; i < totalDataPoints; i+=4) {        
        r += imgData.data[i];
        g += imgData.data[i+1];
        b += imgData.data[i+2];
      } 

      var result = Math.floor(r / totalPixels) + ',' + Math.floor(g / totalPixels) + ',' + Math.floor(b / totalPixels);
      console.log(imgData.data);
      console.log(result);
      return result;
    }

    function stop(e) {
      var stream = video.srcObject;
      var tracks = stream.getTracks();

      for (var i = 0; i < tracks.length; i++) {
        var track = tracks[i];
        track.stop();
      }

      video.srcObject = null;
    }
    </script>
  </body>
</html>